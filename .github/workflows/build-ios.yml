name: Build iOS

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-ios,aarch64-apple-ios-sim
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          src-tauri/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Install dependencies
      run: npm ci
      
    - name: Install Tauri CLI
      run: npm install -g @tauri-apps/cli@next

    - name: Install Bundler and fastlane
      run: |
        gem install bundler
        bundle install
    
    - name: Install xcbeautify (optional, for cleaner output)
      run: |
        brew install xcbeautify || echo "xcbeautify not available, continuing without it"
      
    - name: Import iOS Code Signing Certificate
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      run: |
        echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > /tmp/ios_certificate.p12
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import /tmp/ios_certificate.p12 -k ~/Library/Keychains/build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
        rm /tmp/ios_certificate.p12

    - name: Install iOS Provisioning Profile
      env:
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision))
        mv ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision
        echo "PROVISIONING_PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
        echo "Installed provisioning profile: $PROFILE_UUID"
      
    - name: Setup iOS project
      run: |
        # Initialize iOS project if it doesn't exist
        if [ ! -d "src-tauri/gen/apple" ]; then
          npx @tauri-apps/cli ios init
        else
          echo "iOS project already exists, skipping init"
        fi
      
    - name: Configure Xcode Project for Manual Signing
      env:
        PROVISIONING_PROFILE_UUID: ${{ env.PROVISIONING_PROFILE_UUID }}
      run: |
        # Update Xcode project to use manual code signing
        XCODE_PROJECT="src-tauri/gen/apple/circuit-assistant-mobile-companion.xcodeproj"
        PROJECT_FILE="$XCODE_PROJECT/project.pbxproj"
        
        if [ ! -f "$PROJECT_FILE" ]; then
          echo "Project file not found, will be created by Tauri build"
          exit 0
        fi
        
        # Backup the project file
        cp "$PROJECT_FILE" "$PROJECT_FILE.backup"
        
        # Update code signing settings using sed (simpler and avoids YAML parsing issues)
        # Set CODE_SIGN_STYLE to Manual
        sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$PROJECT_FILE"
        
        # Set CODE_SIGN_IDENTITY to Apple Distribution
        sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Development";/CODE_SIGN_IDENTITY = "Apple Distribution";/g' "$PROJECT_FILE"
        sed -i '' 's/CODE_SIGN_IDENTITY = "";/CODE_SIGN_IDENTITY = "Apple Distribution";/g' "$PROJECT_FILE"
        
        # Update or add PROVISIONING_PROFILE_SPECIFIER
        if grep -q "PROVISIONING_PROFILE_SPECIFIER" "$PROJECT_FILE"; then
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = .*/PROVISIONING_PROFILE_SPECIFIER = $PROVISIONING_PROFILE_UUID;/g" "$PROJECT_FILE"
        else
          # Add PROVISIONING_PROFILE_SPECIFIER after CODE_SIGN_IDENTITY
          sed -i '' "/CODE_SIGN_IDENTITY = \"Apple Distribution\";/a\\
						PROVISIONING_PROFILE_SPECIFIER = $PROVISIONING_PROFILE_UUID;
" "$PROJECT_FILE"
        fi
        
        echo "Updated Xcode project for manual signing with profile: $PROVISIONING_PROFILE_UUID"
      
    - name: Build iOS IPA for TestFlight
      env:
        APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
        APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
        PROVISIONING_PROFILE_UUID: ${{ env.PROVISIONING_PROFILE_UUID }}
      run: |
        # Build Rust library first (this is what Tauri iOS build does internally)
        # We'll skip the full iOS build and do the archive ourselves
        cd src-tauri
        cargo build --target aarch64-apple-ios --release || echo "Rust build may have warnings but continuing..."
        cd ..
        
        # Create ExportOptions.plist for App Store distribution
        mkdir -p build
        cat > build/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>destination</key>
            <string>upload</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>org.circuitassistant.camc</key>
                <string>$PROVISIONING_PROFILE_UUID</string>
            </dict>
        </dict>
        </plist>
        EOF
        
        # Find the generated Xcode project
        XCODE_PROJECT="src-tauri/gen/apple/circuit-assistant-mobile-companion.xcodeproj"
        SCHEME="circuit-assistant-mobile-companion_iOS"
        ARCHIVE_PATH="$PWD/build/ios.xcarchive"
        EXPORT_PATH="$PWD/build/ios-export"
        
        # Archive the app with explicit signing settings
        xcodebuild archive \
          -project "$XCODE_PROJECT" \
          -scheme "$SCHEME" \
          -configuration Release \
          -archivePath "$ARCHIVE_PATH" \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="$PROVISIONING_PROFILE_UUID" \
          DEVELOPMENT_TEAM="" \
          | xcbeautify || cat
        
        # Export IPA for App Store
        xcodebuild -exportArchive \
          -archivePath "$ARCHIVE_PATH" \
          -exportPath "$EXPORT_PATH" \
          -exportOptionsPlist build/ExportOptions.plist \
          | xcbeautify || cat
        
        # Find the IPA
        IPA_FILE=$(find "$EXPORT_PATH" -name "*.ipa" | head -n 1)
        if [ -z "$IPA_FILE" ]; then
          echo "Error: IPA file not found in $EXPORT_PATH"
          ls -la "$EXPORT_PATH" || echo "Export path does not exist"
          exit 1
        fi
        echo "IPA_PATH=$IPA_FILE" >> $GITHUB_ENV
        echo "Built IPA: $IPA_FILE"
      
    - name: Upload to TestFlight
      env:
        APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
        APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
      run: |
        bundle exec fastlane ios testflight ipa:"$IPA_PATH"
      
    - name: Upload iOS build artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: camc-ios-${{ github.ref_name }}
        path: |
          src-tauri/gen/ios/build/
          build/*.ipa
