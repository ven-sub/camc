name: Build iOS

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-ios,aarch64-apple-ios-sim
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          src-tauri/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Install dependencies
      run: npm ci
      
    - name: Install Tauri CLI
      run: npm install -g @tauri-apps/cli@next

    - name: Install Bundler and fastlane
      run: |
        gem install bundler
        bundle install
      
    - name: Import iOS Code Signing Certificate
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
      run: |
        echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > /tmp/ios_certificate.p12
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import /tmp/ios_certificate.p12 -k ~/Library/Keychains/build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
        rm /tmp/ios_certificate.p12

    - name: Install iOS Provisioning Profile
      env:
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision))
        mv ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision
        echo "Installed provisioning profile: $PROFILE_UUID"
      
    - name: Setup iOS project
      run: npm run tauri:ios
      
    - name: Build iOS IPA for TestFlight
      env:
        APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
        APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
      run: |
        # Build the iOS app
        npm run tauri:ios:build
        
        # Create ExportOptions.plist for App Store distribution
        mkdir -p build
        cat > build/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>destination</key>
            <string>upload</string>
        </dict>
        </plist>
        EOF
        
        # Find the generated Xcode project
        XCODE_PROJECT="src-tauri/gen/apple/circuit-assistant-mobile-companion.xcodeproj"
        SCHEME="circuit-assistant-mobile-companion_iOS"
        ARCHIVE_PATH="$PWD/build/ios.xcarchive"
        EXPORT_PATH="$PWD/build/ios-export"
        
        # Get provisioning profile UUID
        PROFILE_UUID=$(ls ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision | head -n 1 | xargs basename | sed 's/.mobileprovision$//')
        
        # Archive the app
        xcodebuild archive \
          -project "$XCODE_PROJECT" \
          -scheme "$SCHEME" \
          -configuration Release \
          -archivePath "$ARCHIVE_PATH" \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
          -allowProvisioningUpdates
        
        # Export IPA for App Store
        xcodebuild -exportArchive \
          -archivePath "$ARCHIVE_PATH" \
          -exportPath "$EXPORT_PATH" \
          -exportOptionsPlist build/ExportOptions.plist \
          -allowProvisioningUpdates
        
        # Find the IPA
        IPA_FILE=$(find "$EXPORT_PATH" -name "*.ipa" | head -n 1)
        if [ -z "$IPA_FILE" ]; then
          echo "Error: IPA file not found"
          exit 1
        fi
        echo "IPA_PATH=$IPA_FILE" >> $GITHUB_ENV
        echo "Built IPA: $IPA_FILE"
      
    - name: Upload to TestFlight
      env:
        APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
        APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
      run: |
        bundle exec fastlane ios testflight ipa:"$IPA_PATH"
      
    - name: Upload iOS build artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: camc-ios-${{ github.ref_name }}
        path: |
          src-tauri/gen/ios/build/
          build/*.ipa
