# Fastlane configuration for iOS and macOS TestFlight uploads

default_platform(:ios)

platform :ios do
  desc "Upload iOS app to TestFlight"
  lane :testflight do
    # Read environment variables from GitHub Actions
    api_key_path = ENV["APPSTORE_API_KEY_PATH"]
    
    if api_key_path && File.exist?(api_key_path)
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: api_key_path,
        duration: 1200, # optional (maximum 1200)
        in_house: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_content: ENV["APPSTORE_PRIVATE_KEY"],
        duration: 1200,
        in_house: false
      )
    end
    
    # Skip precheck validation (not compatible with API keys for IAP checks)
    ENV["FASTLANE_SKIP_PRECHECK"] = "1"
    
    # Upload the build
    deliver(
      skip_screenshots: true,
      skip_metadata: true,
      skip_app_version_update: true,
      force: true,
      submit_for_review: false,
      skip_precheck: true
    )
    
    # Enable the build for internal testing group
    # Note: This requires the build to be processed first (may take a few minutes)
    # If the build isn't ready yet, you'll need to enable it manually or run this later
    begin
      pilot(
        groups: ["MoCom Testers"],  # Internal testing group name
        distribute_external: false,
        skip_waiting_for_build_processing: false,  # Wait for processing to complete
        wait_for_processing: true
      )
      UI.success("Build enabled for MoCom Testers group")
    rescue => ex
      UI.important("Could not automatically enable build for testers: #{ex.message}")
      UI.important("Please enable the build manually in App Store Connect:")
      UI.important("1. Go to TestFlight > Builds")
      UI.important("2. Select the build")
      UI.important("3. Enable it for 'MoCom Testers' group")
    end
  end
end

platform :mac do
  desc "Upload macOS app to TestFlight"
  lane :testflight do
    # Read environment variables from GitHub Actions
    api_key_path = ENV["APPSTORE_API_KEY_PATH"]
    
    if api_key_path && File.exist?(api_key_path)
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: api_key_path,
        duration: 1200,
        in_house: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_content: ENV["APPSTORE_PRIVATE_KEY"],
        duration: 1200,
        in_house: false
      )
    end
    
    # Skip precheck validation (not compatible with API keys for IAP checks)
    ENV["FASTLANE_SKIP_PRECHECK"] = "1"
    
    deliver(
      skip_screenshots: true,
      skip_metadata: true,
      skip_app_version_update: true,
      force: true,
      submit_for_review: false,
      skip_precheck: true
    )
  end
end

