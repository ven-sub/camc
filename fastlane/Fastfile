# Fastlane configuration for iOS and macOS TestFlight uploads

default_platform(:ios)

platform :ios do
  desc "Upload iOS app to TestFlight"
  lane :testflight do
    # Read environment variables from GitHub Actions
    api_key_path = ENV["APPSTORE_API_KEY_PATH"]
    
    if api_key_path && File.exist?(api_key_path)
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: api_key_path,
        duration: 1200, # optional (maximum 1200)
        in_house: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_content: ENV["APPSTORE_PRIVATE_KEY"],
        duration: 1200,
        in_house: false
      )
    end
    
    deliver(
      skip_screenshots: true,
      skip_metadata: true,
      skip_app_version_update: true,
      force: true,
      submit_for_review: false
    )
  end
end

platform :mac do
  desc "Upload macOS app to TestFlight"
  lane :testflight do
    # Read environment variables from GitHub Actions
    api_key_path = ENV["APPSTORE_API_KEY_PATH"]
    
    if api_key_path && File.exist?(api_key_path)
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: api_key_path,
        duration: 1200,
        in_house: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_content: ENV["APPSTORE_PRIVATE_KEY"],
        duration: 1200,
        in_house: false
      )
    end
    
    deliver(
      skip_screenshots: true,
      skip_metadata: true,
      skip_app_version_update: true,
      force: true,
      submit_for_review: false
    )
  end
end

