# Fastlane configuration for iOS and macOS TestFlight uploads

default_platform(:ios)

platform :ios do
  desc "Upload iOS app to TestFlight"
  lane :testflight do
    # Read environment variables from GitHub Actions
    api_key_path = ENV["APPSTORE_API_KEY_PATH"]
    
    if api_key_path && File.exist?(api_key_path)
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: api_key_path,
        duration: 1200, # optional (maximum 1200)
        in_house: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_content: ENV["APPSTORE_PRIVATE_KEY"],
        duration: 1200,
        in_house: false
      )
    end
    
    # Upload to TestFlight using pilot (not deliver which is for App Store)
    pilot(
      skip_submission: true,  # Don't submit for beta review automatically
      skip_waiting_for_build_processing: true  # Don't wait 20+ minutes
    )
    
    # Note: Automatic group enabling disabled to avoid 20+ minute wait times
    # Enable builds manually in App Store Connect after upload:
    # 1. Go to TestFlight > Builds > iOS
    # 2. Select the build
    # 3. Enable it for 'MoCom Testers' group
    UI.success("Build uploaded successfully!")
    UI.important("To enable for testers: App Store Connect > TestFlight > Builds > Enable for 'MoCom Testers'")
  end
end

platform :mac do
  desc "Upload macOS app to TestFlight"
  lane :testflight do
    # Read environment variables from GitHub Actions
    api_key_path = ENV["APPSTORE_API_KEY_PATH"]
    
    if api_key_path && File.exist?(api_key_path)
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_filepath: api_key_path,
        duration: 1200,
        in_house: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_content: ENV["APPSTORE_PRIVATE_KEY"],
        duration: 1200,
        in_house: false
      )
    end
    
    # Skip precheck validation (not compatible with API keys for IAP checks)
    ENV["FASTLANE_SKIP_PRECHECK"] = "1"
    
    deliver(
      skip_screenshots: true,
      skip_metadata: true,
      skip_app_version_update: true,
      force: true,
      submit_for_review: false,
      skip_precheck: true
    )
  end
end

